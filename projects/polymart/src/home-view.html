<style> 
  home-view {
    display: block;
    background-color: white;
  }
  [hero] {
    height: 240px;
    background-color: white;
    transition: opacity 200ms ease-in-out;
  }
  product-view {
    box-shadow: 0 1px 2px 1px rgba(0,0,0,0.25);
    padding: 16px;
  }
  [hero] > div {
    padding: 16px;
  }
  product-carousel {
    height: 116px;
    padding: 10px 0 20px;
    margin: 0 8px;
    font-size: 0.7em;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  product-carousel > div {
    width: 96px;
    margin: 0 12px;
  }
  product-carousel img {
    width: 100%;
  }
  action-call {
    height: 226px;
    padding: 4px 16px;
  }
  categories-view {
    color: #007dc6;
  }
  h3 {
    margin: 8px 16px;
    font-size: 1.2em;
  }
</style>

<dom-module id="mini-view">
  <template>
    <div noflex vertical center layout>
      <img src="{{src}}">
      <span>{{price}}</span>
      <span>{{item}}</span>
    </div>
  </template>
</dom-module>

<dom-module id="home-view">

  <template>
    
    <div vertical layout>
      
      <nano-carousel hero style%="{{carouselStyle}}" vertical middle layout></nano-carousel>

      <h3>Other popular items</h3>

      <product-carousel horizontal center layout></product-carousel>

      <h3>Value of the day</h3>

      <action-call vertical middle layout>
        <product-view product="{{vod}}"></product-view>
      </action-call>

      <h3>Shop by department</h3>

      <categories-view vertical middle layout categories="{{categories}}"></categories-view>

    </div>

    <nano-ajax url="mart/trending.php" on-response="onTrendingResponse"></nano-ajax>
    <nano-ajax url="mart/vod.php" on-response="onVodResponse"></nano-ajax>

  </template>

  <script>
    document.registerElement('home-view', {
      prototype: {
        __proto__: HTMLElement.prototype,
        createdCallback: function() {
          this.dom = Annotations.stamp('home-view', this);
          this.dom.set('carouselStyle', {opacity: 0});
        },
        set categories(categories) {
          this.dom.set({categories: categories});
        },
        onVodResponse: function(e) {
          this.dom.set({vod: e.detail});
        },
        onTrendingResponse: function(e) {
          var proxy = function(url) {
            return url ? 'mart/proxy.php?' + encodeURIComponent(url) : '';
          }
          //
          var crsl = this.dom.$('[hero]');
          crsl.textContent = '';
          if (e.detail) {
            var items = e.detail.items;
            for (var i=0; i<5; i++) {
              var pv = document.createElement('product-view');
              crsl.appendChild(document.createElement('div')).appendChild(pv);
              pv.product = items[i];
            }
            crsl.style.opacity = 1;
            crsl.start();
          }
          //
          var pc = this.dom.$('product-carousel');
          pc.textContent = '';
          if (e.detail) {
            var items = e.detail.items;
            for (var i=0; i<20; i++) {
              var item = items[i + 5];
              var frag = document.createDocumentFragment();
              Annotations.stamp('mini-view', frag).set({
                price: '$' + (item.salePrice || item.msrp || (item.bestMarketplacePrice && item.bestMarketplacePrice.price)),
                name: item.name,
                src: proxy(item.thumbnailImage)
              });
              pc.appendChild(frag);
            }
          }
        }
      }  
    });
  </script>
  
</dom-module>